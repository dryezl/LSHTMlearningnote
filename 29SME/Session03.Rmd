
在本次練習題中，我們學習如何繪製 Kaplan-Meier 生存曲線，並且學會使用 Logrank 檢驗方法來比較不同組之間的生存曲線是否有統計學上的不一致。

## Q1 

打開數據 `trinmlsh`。使用 Stata 的 `describe` 和 `sum` 命令熟悉該數據的各個變量的名字和大致內容。主要是確認一下哪些變量含有重要的結果變量信息，和生存時間信息。`help trinmlsh` 可以調取關於該數據更加詳細的背景和內容介紹。

```{r SME03-01stata,  engine='stata', cache=TRUE, echo=FALSE}
cd "~/Downloads/LSHTMlearningnote/backupfiles/"
use trinmlsh

describe
sum

```


```
help trinmlsh
```

```
COHORT STUDY OF RISK FACTORS FOR MORTALITY AMONG MALES IN TRINIDAD

All males aged 35-74 years who were living in two neighbouring suburbs 
of Port of Spain, Trinidad, in March 1977 were eligible and entered into 
the study. Baseline data were recorded for 1,343 men on a range of risk
factors including ethnic group, blood pressure, glucoose and lipoprotein
concentrations, diabetes mellitus, and cigarette and alchool consumption.

All subjects were then visited annually at home, and morbidity and 
mortality records were compiled.  Regular inspection of hospital records,
death registers and obitaries were also used to update the records.
Those who had moved away (or abroad) were contacted annually by postal
questionnaire and were also seen if they returned to to Port of Spain.
By these means, loss to follow-up was kept very low.

Follow-up of the study cohort finished at the end of 1986, giving a study
period of almost ten years.

The file trinmlsh contains data on selected risk factors for the
subset of men aged 60 years or over.  There were 318 men in this group, and
88 deaths were recorded.  Of these deaths, 22 were attributed to 
 cardiovascular disease.  The file holds the following variables:

ethgp        ethnic group (1=African,2=Indian,3=European,4=mixed,5=Chin/Sem)
ageent       age in years at first survey
death        death from any cause (0=no,1=yes)
cvdeath      death from CV disease (0=no,1=yes)
alc          Drinks per week (0=none,1=1-4,2=5-14,3=15+)
smokenum     No. cigs per day (0=non-sm,1=ex,2=1-9,3=10-19,4=20-29,5=30+)
hdlc         HDL cholesterol
diabp        diastolic BP (mm Hg)
sysbp        systolic BP (mm Hg)
chdstart     heart disease  at time of entry (0=no,1=yes)
days         days of follow-up 
years        years of follow-up 
bmi          body mass index (wt/(ht*ht))
id           Subject identifier
timein       Date of entry (days since 1/1/1960)
timeout      Date of exit  (days since 1/1/1960)
timebth      Date of birth (days since 1/1/1960)
```

我們從數據的簡介和變量名字中不難猜出，`death` 是該研究對象的總死亡結果變量，`cvdeath` 則特別是死於心血管疾病的結果變量。另外 `years` 和 `y` 是內容相同的追蹤時間長度變量，單位是“年”，另一個含有相同信息的時間變量是 `days` “日”。


## Q2

分析該數據中男性的總死亡 `death`，繪製總體人羣的一張 Kaplan-Meier 生存曲線圖。


```{r SME03-02stata,  engine='stata', cache=TRUE, echo=FALSE}
cd "~/Downloads/LSHTMlearningnote/backupfiles/"
use trinmlsh

stset timeout, fail(death) origin(timein) enter(timein) scale(365.25) id(id)
```

在 Stata 繪製 Kaplan-Meier 生存曲線極其簡單：

```
sts graph, saving(plot1)
```


```{r SME03-statafig1, cache=TRUE, fig.width=6, fig.height=5, echo = FALSE, fig.cap="`sts graph, saving(plot1)`", fig.align='center'}
knitr::include_graphics(paste0(bugpath, "/img/plot1.jpg"))
```



## Q3 

使用 `sts list` 命令來查看該數據中第1，3，和5年時的累計生存概率 (cumulative survival probability)。

```{r SME03-03stata,  engine='stata', cache=TRUE, echo=FALSE}
cd "~/Downloads/LSHTMlearningnote/backupfiles/"
use trinmlsh
quietly stset timeout, fail(death) origin(timein) enter(timein) scale(365.25) id(id)
sts list, at(1, 3, 5)
```


## Q4 


給Q2 的 Kaplan-Meier 曲線添加 95% 信賴區間:


```
sts graph, ci saving(plot1, replace)
```

```{r SME03-statafig2, cache=TRUE, fig.width=6, fig.height=5, echo = FALSE, fig.cap="`sts graph,  ci saving(plot1, replace)`", fig.align='center'}
knitr::include_graphics(paste0(bugpath, "/img/plot1_ci.jpg"))
```

## Q5

關注變量 `smokenum`， 查看它的詳細內容。



```{r SME03-04stata,  engine='stata', cache=TRUE, echo=FALSE}
cd "~/Downloads/LSHTMlearningnote/backupfiles/"
use trinmlsh
quietly stset timeout, fail(death) origin(timein) enter(timein) scale(365.25) id(id)
tab smokenum
tab smokenum, nolabel
```



生成一個新的變量區分對象是否是現在有吸菸習慣 "current smoker"。比較現在有吸菸習慣和無吸菸習慣的兩組對象的生存曲線，這兩條曲線之間是否有（統計學上的）不同？

```{r SME03-05stata,  engine='stata', cache=TRUE, echo=FALSE}
cd "~/Downloads/LSHTMlearningnote/backupfiles/"
use trinmlsh
quietly stset timeout, fail(death) origin(timein) enter(timein) scale(365.25) id(id)
gen smokstatus = smokenum >= 2 if smokenum != .
label define smokstatus 0 "non-smokers" 1 "current smokers"
label value smokstatus smokstatus
```

繪製兩組人的生存概率曲線，需要用到 `by(smokstatus)` 選項。

```
sts graph, by(smokstatus)
```

```{r SME03-statafig3, cache=TRUE, fig.width=6, fig.height=5, echo = FALSE, fig.cap="`sts graph, by(smokstatus)`", fig.align='center'}
knitr::include_graphics(paste0(bugpath, "/img/plot3_1.jpg"))
```

可以看到吸菸和不吸菸兩組人的生存曲線在追蹤到第四年左右之前都十分相似。但是再往後的觀察隨訪時間裏，吸菸者的希望概率似乎要更高。


## Q6

檢驗吸菸習慣不同的兩組實驗對象的生存曲線在整個隨訪過程中是否有統計學意義上的不同？

```{r SME03-06stata,  engine='stata', cache=TRUE, echo=FALSE}
cd "~/Downloads/LSHTMlearningnote/backupfiles/"
use trinmlsh
quietly stset timeout, fail(death) origin(timein) enter(timein) scale(365.25) id(id)
gen smokstatus = smokenum >= 2 if smokenum != .
label define smokstatus 0 "non-smokers" 1 "current smokers"
label value smokstatus smokstatus
sts test smokstatus
```

Logrank 檢驗結果提示吸菸和不吸菸兩組人的生存曲線確實存在統計學上的差異 (p = 0.03)。


