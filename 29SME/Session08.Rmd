

本章的練習，我們主要使用四個計算似然的命令來加深我們對似然這一概念的理解：

- `blik`: binomial likelihood （二項分佈的似然）
- `plik`: Poisson likelihood （泊松分佈的似然）
- `bloglik`: binomial log-likelihood （二項分佈的對數似然）
- `ploglik`: Poisson log-likelihood （泊松分佈的對數似然）


## Q1 二項分佈似然的圖形

在R語言中繪製二項分佈參數 $\pi$ 在不同情況下的似然函數圖： 


1. 10次實驗中4次失敗：

```{r binomL4, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Binomial(10, 4) Likelihood ratio ', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^4)*((1-x)^6) / (0.4^4*0.6^6)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
abline(v=0.4, lty=2)
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
```

2，100次實驗中40次失敗：

```{r binomL40, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Binomial(100, 40) Likelihood ratio', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^40)*((1-x)^60) / (0.4^40*0.6^60)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
abline(h=1.0, lty=2)
abline(v=0.4, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")

```

3. 1000 次實驗中 400 次失敗：

```{r binomL400, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Binomial(1000, 400) Likelihood ratio', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^400)*((1-x)^600) / (0.4^400*0.6^600)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
abline(v=0.4, lty=2)
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
```


三個圖的整體信息告訴我們，數據越多，對參數的估計越精確 (more data more precise estimate)。


## Q2 修改信賴區間的寬度

把紅線刻度從 0.1466 改成 0.2585，會發生怎樣的改變？


```{r binomL401, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Binomial(100, 40) Likelihood ratio, with 90% CI.', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^40)*((1-x)^60) / (0.4^40*0.6^60)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
abline(h=1.0, lty=2)
abline(v=0.4, lty=2)
abline(h=0.2585, lty=2, lwd = 2, col = "red")
```
當改成使用 90% 信賴區間的時候，區間變窄，但其實我們對這個區間的長期重複實驗結果是否包含真實參數值的信心變小了。(less confident about the interval)

## Q3 嘗試繪製一些極端情況下的似然函數圖

1. 假如繪製如 10 次實驗中 1 次失敗的二項分佈參數似然函數圖：

```{r binomL19, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Binomial(10, 1) Likelihood ratio ', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^1)*((1-x)^9) / (0.1^1*0.9^9)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
abline(v=0.1, lty=2)
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
```
2. 假如繪製如 100 次實驗中 1 次失敗的二項分佈參數似然函數圖：

```{r binomL199, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Binomial(100, 1) Likelihood ratio ', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^1)*((1-x)^99) / (0.01^1*0.99^99)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
abline(v=0.01, lty=2)
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
```

當實驗結果或數據較爲極端的時候，我們發現似然比不再和正（常）態分佈近似，也越來越偏向一邊。(no longer symmertrical and bell-shaped with extreme splits)


## Q4 失敗次數爲 0 會發生什麼


當多次實驗中觀察到 0 次失敗，那麼似然函數會變成怎樣？




1. 10次實驗中0次失敗：

```{r binomL0, cache=TRUE, fig.width=6, fig.height=5, echo = FALSE, fig.cap='Binomial(10, 4) Likelihood ratio ', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^0)*((1-x)^10) / (0.0^0*1^10)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
# abline(v=0.4, lty=2)
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
```

2，100次實驗中0次失敗：

```{r binomL10, cache=TRUE, fig.width=6, fig.height=5, echo = FALSE, fig.cap='Binomial(100, 40) Likelihood ratio', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^0)*((1-x)^100) / (0^0*1^100)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
abline(h=1.0, lty=2)
# abline(v=0.4, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")

```

3. 1000 次實驗中 0 次失敗：

```{r binomL100, cache=TRUE, fig.width=6, fig.height=5, echo = FALSE, fig.cap='Binomial(1000, 400) Likelihood ratio', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^0)*((1-x)^1000) / (0^0*1^1000)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
# abline(v=0.4, lty=2)
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
```

於是我們知道當沒有失敗時，二項分佈數據的參數 $\pi$ 的似然函數沒有轉折點。(no turning point)


## Q5 泊松分佈參數的似然函數


在R語言中繪製泊松分佈參數 $\lambda$ 在不同情況下的似然函數圖： 


1. 500人年的觀察中發現7人死亡：

```{r poissonL4, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Poisson Likelihood ratio for rate parameter D = 7, Y = 500', fig.align='center', out.width='90%'}
x <- seq(0, 40, by=0.1)/1000
y <- exp( -500 * x + 7 + 7 * log( x * 500)  - 7 * log(7))
plot(x, y, type = "l", ylab = "LR(\u03BB)", xlab = ~lambda)
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
```

2. 5000人年的觀察中發現70人死亡：

```{r poissonL40, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Poisson Likelihood ratio for rate parameter D = 70, Y = 5000', fig.align='center', out.width='90%'}
x <- seq(0, 40, by=0.01)/1000
y <- exp( -5000 * x + 70 + 70 * log( x * 5000)  - 70 * log(70))
plot(x, y, type = "l", ylab = "LR(\u03BB)", xlab = ~lambda)
abline(h=1.0, lty=2)
abline(v=0.4, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")

```

3. 50000人年的觀察中發現700人死亡：

```{r poissonL400, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Poisson Likelihood ratio for rate parameter D = 700, Y = 50000', fig.align='center', out.width='90%'}
x <- seq(0, 40, by=0.01)/1000
y <- exp( -50000 * x + 700 + 700 * log( x * 50000)  - 700 * log(700))
plot(x, y, type = "l", ylab = "LR(\u03BB)", xlab = ~lambda)
abline(v=0.4, lty=2)
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
```


三個圖的整體信息仍然告訴我們，數據越多，對參數的估計越精確 (more data more precise estimate)。


## Q6 特別少的病例死亡的情況

當觀察到特別少， 如 1，或者 0 個病例死亡時，泊松分佈的似然函數圖形會是怎樣的？



1. 500人年的觀察中發現1人死亡：

```{r poissonL1, cache=TRUE, fig.width=6, fig.height=5, echo  = FALSE, fig.cap='Poisson Likelihood ratio for rate parameter D = 1, Y = 500', fig.align='center', out.width='90%'}
x <- seq(0, 40, by=0.1)/1000
y <- exp( -500 * x + 1 + 1 * log( x * 500)  - 1 * log(1))
plot(x, y, type = "l", ylab = "LR(\u03BB)", xlab = ~lambda)
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
```

2. 500人年的觀察中發現0人死亡

```{r poissonL0, cache=TRUE, fig.width=6, fig.height=5, echo  = FALSE, fig.cap='Poisson Likelihood ratio for rate parameter D = 0, Y = 500', fig.align='center', out.width='90%'}
x <- seq(0, 40, by=0.1)/1000
y <- exp( -500 * x + 0 + 0 * log( x * 500)  - 0 * log(7))
plot(x, y, type = "l", ylab = "LR(\u03BB)", xlab = ~lambda)
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
```

3. 5000人年的觀察中發現10人死亡：

```{r poissonL10, cache=TRUE, fig.width=6, fig.height=5, echo  = FALSE, fig.cap='Poisson Likelihood ratio for rate parameter D = 10, Y = 5000', fig.align='center', out.width='90%'}
x <- seq(0, 40, by=0.01)/1000
y <- exp( -5000 * x + 10 + 10 * log( x * 5000)  - 1 * log(10))
plot(x, y, type = "l", ylab = "LR(\u03BB)", xlab = ~lambda)
abline(h=1.0, lty=2)
abline(v=0.4, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
```

4. 5000人年的觀察中發現1人死亡：

```{r poissonL100, cache=TRUE, fig.width=6, fig.height=5, echo  = FALSE, fig.cap='Poisson Likelihood ratio for rate parameter D = 1, Y = 5000', fig.align='center', out.width='90%'}
x <- seq(0, 40, by=0.01)/1000
y <- exp( -5000 * x + 1 + 1 * log( x * 5000)  - 1 * log(1))
plot(x, y, type = "l", ylab = "LR(\u03BB)", xlab = ~lambda)
abline(h=1.0, lty=2)
abline(v=0.4, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")

```


和二項分佈時觀察到的結果一樣，當觀察值極端低的話，我們得到的似然函數的曲線就不再是左右對稱的類似正（常）態分佈的曲線了。

## Q7 25人中15人選A

假如令25名受試對象從 A 和 B 兩種方案中選擇一個，他們各自的決定不影響其他人的選擇。觀察到15人選A，10人選B。繪製這個命題的二項分佈似然函數曲線：


1. 10次實驗中4次失敗：

```{r binomL2515, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Binomial(25, 15) Likelihood ratio', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^15)*((1-x)^10) / ((15/25)^15*(10/25)^10)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
abline(v=15/25, lty=2)
abline(v=0.5, lty=2, lwd = 2, col = "blue")
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
abline(h=(0.5^15)*((1-0.5)^10) / ((15/25)^15*(10/25)^10), lty=2, lwd = 2, col = "red")
```


拿這個實驗的結果和我們認爲的零假設 “$\pi = 0.5$，選A 和選B 的概率相同” 做假設檢驗會得到怎樣的 P 值？

```{r binomL25_15test}

binom.test(x = 15, n = 25, p = 0.5)

# likelihood ratio for null value
(0.5^15)*((1-0.5)^10) / ((15/25)^15*(10/25)^10)
```

## Q8 40人中24人選A



```{r binomL4024, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Binomial(40, 24) Likelihood ratio', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^24)*((1-x)^16) / ((24/40)^24*(16/40)^16)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
abline(v=24/40, lty=2)
abline(v=0.5, lty=2, lwd = 2, col = "blue")
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
abline(h=(0.5^24)*((1-0.5)^16) / ((24/40)^24*(16/40)^16), lty=2, lwd = 2, col = "red")
```

和相同的零假設做檢驗。


```{r binomL40_24test}

binom.test(x = 24, n = 40, p = 0.5)

# likelihood ratio for null value
(0.5^24)*((1-0.5)^16) / ((24/40)^24*(16/40)^16)
```

## Q9 60人中36人選A

```{r binomL6036, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Binomial(25, 15) Likelihood ratio ', fig.align='center', out.width='90%'}
x <- seq(0,1,by=0.001)
y <- (x^36)*((1-x)^24) / ((36/60)^36*(24/60)^24)
plot(x, y, type = "l", ylab = "LR(\U03C0)", xlab = "\U03C0")
abline(v=36/60, lty=2)
abline(v=0.5, lty=2, lwd = 2, col = "blue")
abline(h=1.0, lty=2)
abline(h=0.1466, lty=2, lwd = 2, col = "red")
abline(h=(0.5^36)*((1-0.5)^24) / ((36/60)^36*(24/60)^24), lty=2, lwd = 2, col = "red")
```


和相同的零假設做檢驗。


```{r binomL60_36test}

binom.test(x = 36, n = 60, p = 0.5)

# likelihood ratio for null value
(0.5^36)*((1-0.5)^24) / ((36/60)^36*(24/60)^24)

```

我們發現，當觀察數值的 $\hat{\pi} = 0.6$ 保持不變，但數據量越多，p值就變得越小。

## Q10 繪製精確 exact 和 近似 approximate 對數似然函數

1. 假設10名患者有4人最終死亡，繪製該實驗的精確對數似然，和近似對數似然圖


```{r binomLoglik104, cache=TRUE, fig.width=6, fig.height=5, echo = TRUE, fig.cap='Log likelihood for risk parameter: D = 4, H = 6', fig.align='center', out.width='90%'}
par(mai = c(1.2, 0.5, 1, 0.7))
pi <- seq(0.05, 0.9, by=0.001)
L <- (pi^4)*((1-pi)^6)
Lmax <- rep(max(L), length(pi))
LR <- L/Lmax
logLR <- log(LR)

# the exact binomial log likelihood ratio
plot(pi, logLR, type = "l", col = "red", ylim = c(-5, 0), yaxt="n",
     ylab = "logLR(\U03C0)", xlab = "\U03C0")

# the approximate quadratic binomial log-likelihood ratio
quad <-  -(pi-0.4)^2/(2*0.024)
lines(pi, quad, col="blue")

grid(NA, 5, lwd = 2) # add some horizontal grid on the background
axis(2, at=seq(-5,0,1), las=2)
axis(4, at=-1.92, las=2)

abline(h=-1.92, lty=1, col="red")
legend(x=0.15, y= -4 ,xpd = TRUE,  legend=c("exact logLR","Quadratic approx"), bty = "n",
       col=c("blue","red"), lty=c(1,1), horiz = TRUE) #the legend is below the graph
```


即便是只有10個觀察值的二項分佈數據，使用二次方程近似法給出的結果也較爲接近精確值。


